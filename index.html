<script>
  let uploadedPdfsBase64 = []; // Lưu dữ liệu PDF tạm thời

  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");

  // Xử lý xem trước ảnh sản phẩm
  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    const reader = new FileReader();
    reader.onload = () => { preview.src = reader.result; };
    reader.readAsDataURL(file);
  });

  // Xử lý nạp PDF vào bộ nhớ
  async function uploadPDF() {
    const pdfInput = document.getElementById("pdfInput");
    const status = document.getElementById("pdfStatus");
    
    if (pdfInput.files.length === 0) return alert("Chọn ít nhất 1 file PDF");

    status.innerHTML = "Đang nạp Style Guide...";
    uploadedPdfsBase64 = [];

    for (let file of pdfInput.files) {
      const base64 = await toBase64(file);
      uploadedPdfsBase64.push(base64);
    }

    status.innerHTML = `✅ Đã nạp ${pdfInput.files.length} file Style Guide.`;
  }

  // Hàm bổ trợ chuyển file sang Base64
  const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });

  // Gửi dữ liệu đi phân tích
  async function analyze() {
    if (!preview.src || uploadedPdfsBase64.length === 0) {
      alert("Vui lòng tải lên cả ảnh sản phẩm và PDF style guide!");
      return;
    }

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "⏳ AI đang đối chiếu ảnh với Style Guide trong PDF... (có thể mất 10s)";

    try {
      const response = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          imageBase64: preview.src,
          pdfDataList: uploadedPdfsBase64
        })
      });

      const data = await response.json();
      resultDiv.innerHTML = `
        <div style="margin-top:20px; border: 2px solid #007bff; padding: 15px; border-radius: 8px;">
          <h3 style="color:#007bff">Kết quả phân tích:</h3>
          <p><b>Style:</b> ${data.style}</p>
          <p><b>Lý do:</b> ${data.reason}</p>
        </div>
      `;
    } catch (err) {
      resultDiv.innerHTML = "❌ Lỗi khi phân tích. Vui lòng kiểm tra API Key.";
    }
  }
</script>
